/**
 * @fileoverview Firestore Security Rules for AkiliPesa application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure access to user-owned data while allowing public read access where appropriate.
 * It enforces strict ownership for user profiles, clones, and agents. Public data like posts and products
 * are readable by everyone but writable only by the owner.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}` (e.g., `/users/{userId}/clones/{cloneId}`).
 * - Public data resides in top-level collections (e.g., `/posts/{postId}`, `/products/{productId}`).
 *
 * Key Security Decisions:
 * - Listing of user documents is disallowed for security.
 * - Public read access is granted to `/posts` and `/products` collections, with owner-only writes.
 * - Transactions are only accessible to the user that created them, and they can be listed.
 * - Admin settings are read and writable by authorized accounts.
 *
 * Denormalization for Authorization:
 *  - The rules assume that documents in `/posts` and `/products` have an `authorId` or `ownerId` field.
 *  - No rules from `/posts/{postId}` or `/products/{productId}` can read data outside of those documents
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their profile.
     * @allow (get, update, delete) User with matching UID can get, update and delete their profile.
     * @deny (create) User cannot create a profile with a different UID.
     * @deny (get, update, delete) User cannot get, update or delete another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure access to user posts.
     * @path /posts/{postId}
     * @allow (get, list) Public read access for all posts.
     * @allow (create) User can create a post with their UID as authorId.
     * @allow (update, delete) User can update/delete their own post.
     * @deny (create) User cannot create a post with a different authorId.
     * @deny (update, delete) User cannot update/delete another user's post.
     * @principle Public read, owner-only writes for posts.
     */
    match /posts/{postId} {
      function isOwner() {
        return request.auth != null && resource.data.authorId == request.auth.uid;
      }
      function isCreatingOwner() {
        return request.auth != null && request.resource.data.authorId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if request.auth != null && isCreatingOwner();
      allow update: if request.auth != null && isOwner();
      allow delete: if request.auth != null && isOwner();
    }

    /**
     * @description Secure access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) User can create a clone under their profile.
     * @allow (get, update, delete) User can get, update and delete their own clone.
     * @deny (create) User cannot create a clone under another user's profile.
     * @deny (get, update, delete) User cannot get, update or delete another user's clone.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clones/{cloneId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure access to user-specific agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) User can create an agent under their profile.
     * @allow (get, update, delete) User can get, update and delete their own agent.
     * @deny (create) User cannot create an agent under another user's profile.
     * @deny (get, update, delete) User cannot get, update or delete another user's agent.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/agents/{agentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure access to products.
     * @path /products/{productId}
     * @allow (get, list) Public read access for all products.
     * @allow (create) User can create a product with their UID as ownerId.
     * @allow (update, delete) User can update/delete their own product.
     * @deny (create) User cannot create a product with a different ownerId.
     * @deny (update, delete) User cannot update/delete another user's product.
     * @principle Public read, owner-only writes for products.
     */
    match /products/{productId} {
      function isOwner() {
        return request.auth != null && resource.data.ownerId == request.auth.uid;
      }
       function isCreatingOwner() {
        return request.auth != null && request.resource.data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if request.auth != null && isCreatingOwner();
      allow update: if request.auth != null && isOwner();
      allow delete: if request.auth != null && isOwner();
    }

    /**
     * @description Secure access to orders.
     * @path /orders/{orderId}
     * @allow (get) Anyone can get an order.
     * @allow (list) Anyone can list orders.
     * @allow (create) Any authenticated user can create orders.
     * @allow (update, delete) No one can update or delete orders.
     */
    match /orders/{orderId} {
        allow get, list: if true;
        allow create: if request.auth != null;
        allow update, delete: if false;
    }

    /**
     * @description Secure access to payments.
     * @path /payments/{paymentId}
     * @allow (get) Anyone can get a payment.
     * @allow (list) Anyone can list payments.
     * @allow (create) Any authenticated user can create payments.
     * @allow (update, delete) No one can update or delete payments.
     */
    match /payments/{paymentId} {
        allow get, list: if true;
        allow create: if request.auth != null;
        allow update, delete: if false;
    }

    /**
     * @description Secure access to plans.
     * @path /plans/{planId}
     * @allow (get) Anyone can get a plan.
     * @allow (list) Anyone can list plans.
     * @allow (create) Any authenticated user can create plans.
     * @allow (update, delete) No one can update or delete plans.
     */
    match /plans/{planId} {
        allow get, list: if true;
        allow create: if request.auth != null;
        allow update, delete: if false;
    }

    /**
     * @description Secure access to calls.
     * @path /calls/{callId}
     * @allow (get) Anyone can get a call.
     * @allow (list) Anyone can list calls.
     * @allow (create) Any authenticated user can create calls.
     * @allow (update, delete) No one can update or delete calls.
     */
    match /calls/{callId} {
        allow get, list: if true;
        allow create: if request.auth != null;
        allow update, delete: if false;
    }

    /**
     * @description Secure access to transactions.
     * @path /transactions/{txId}
     * @allow (get) User can get their own transaction.
     * @allow (list) User can list their own transactions.
     * @allow (create) User can create a transaction with their own uid.
     * @allow (update, delete) No one can update or delete a transaction.
     * @principle User can only access their own transaction data.
     */
    match /transactions/{txId} {
      function isOwner() {
        return request.auth != null && resource.data.uid == request.auth.uid;
      }
      function isCreatingOwner() {
        return request.auth != null && request.resource.data.uid == request.auth.uid;
      }

      allow get: if request.auth != null && isOwner();
      allow list: if request.auth != null;
      allow create: if request.auth != null && isCreatingOwner();
      allow update, delete: if false;
    }

    /**
     * @description Secure access to admin settings.
     * @path /adminSettings/{settingId}
     * @allow (get) Anyone can get admin settings.
     * @allow (list) Anyone can list admin settings.
     * @allow (create, update, delete) No one can create, update, or delete admin settings.
     */
    match /adminSettings/{settingId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Secure access to admin agents.
     * @path /adminAgents/{agentId}
     * @allow (get) Anyone can get an admin agent.
     * @allow (list) Anyone can list admin agents.
     * @allow (create, update, delete) No one can create, update, or delete admin agents.
     */
    match /adminAgents/{agentId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }
  }
}