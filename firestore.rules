/**
 * @fileoverview Firestore Security Rules for AkiliPesa application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of user-ownership and role-based access control. Most data is scoped to individual users,
 * with stricter controls on potentially sensitive financial data (transactions). Administrative access is granted based on email verification.
 *
 * Data Structure:
 * - User-specific data (profiles, clones, agents) is nested under `/users/{userId}`.
 * - Top-level collections (posts, products, orders, payments, plans, calls, transactions) store global data,
 *   with some requiring owner-based access control.
 * - `/adminSettings` and `/adminAgents` store administrative configurations.
 *
 * Key Security Decisions:
 * - User listing is disabled to prevent enumeration.
 * - Transactions are strictly controlled: users can only access their own, while admins have broader access.
 * - Public read access is granted cautiously and only when an ownership field is present for write control.
 * - The rules now include checks for the `uid` field in both `/users/{userId}` and `/transactions/{txId}` collections to
 *   ensure that the `uid` is consistent with the user's authentication state.
 *
 * Denormalization for Authorization:
 * The rules rely on the denormalization of the `uid` field on `transactions` and `users` documents to determine ownership.
 * This avoids the need for complex queries or additional reads to authorize access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profiles.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their own profile (where userId == auth.uid).
     * @allow (update) Authenticated user can update their own profile, ensuring UID is stable.
     * @allow (delete) Authenticated user can delete their own profile.
     * @deny (get) Authenticated user cannot read another user's profile.
     * @deny (list) No user listing allowed.
     * @deny (create) Creating profile with mismatched userId.
     * @deny (update) Updating profile with mismatched userId or attempting to change the UID.
     * @deny (delete) Deleting another user's profile.
     * @principle Enforces user ownership and prevents unauthorized access to user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId && request.resource.data.uid == resource.data.uid;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Grants public read access to posts, but restricts write access to the post author.
     * @path /posts/{postId}
     * @allow (get) Any user can read a post.
     * @allow (list) Any user can list posts.
     * @allow (create) Authenticated user can create a post with their authorId.
     * @allow (update) Authenticated user can update their own post.
     * @allow (delete) Authenticated user can delete their own post.
     * @deny (create) User cannot create a post with an incorrect authorId.
     * @deny (update) User cannot update another user's post.
     * @deny (delete) User cannot delete another user's post.
     * @principle Allows public read access but enforces ownership for writes.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorId);

      function isExistingOwner(authorId) {
        return isSignedIn() && request.auth.uid == authorId && resource != null;
      }
    }

    /**
     * @description Grants access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (get) Authenticated user can read their own clone.
     * @allow (list) Authenticated user can list their own clones.
     * @allow (create) Authenticated user can create a clone under their ID.
     * @allow (update) Authenticated user can update their own clone.
     * @allow (delete) Authenticated user can delete their own clone.
     * @deny (get) Authenticated user cannot read another user's clone.
     * @deny (list) Authenticated user cannot list another user's clones.
     * @deny (create) Authenticated user cannot create a clone under another user's ID.
     * @deny (update) Authenticated user cannot update another user's clone.
     * @deny (delete) Authenticated user cannot delete another user's clone.
     * @principle Enforces user ownership for clone management.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);

      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
    }

    /**
     * @description Grants access to user-specific agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (get) Authenticated user can read their own agent.
     * @allow (list) Authenticated user can list their own agents.
     * @allow (create) Authenticated user can create an agent under their ID.
     * @allow (update) Authenticated user can update their own agent.
     * @allow (delete) Authenticated user can delete their own agent.
     * @deny (get) Authenticated user cannot read another user's agent.
     * @deny (list) Authenticated user cannot list another user's agents.
     * @deny (create) Authenticated user cannot create an agent under another user's ID.
     * @deny (update) Authenticated user cannot update another user's agent.
     * @deny (delete) Authenticated user cannot delete another user's agent.
     * @principle Enforces user ownership for agent management.
     */
    match /users/{userId}/agents/{agentId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);

      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
    }

    /**
     * @description Grants public read access to products, but restricts write access to the product owner.
     * @path /products/{productId}
     * @allow (get) Any user can read a product.
     * @allow (list) Any user can list products.
     * @allow (create) Authenticated user can create a product with their ownerId.
     * @allow (update) Authenticated user can update their own product.
     * @allow (delete) Authenticated user can delete their own product.
     * @deny (create) User cannot create a product with an incorrect ownerId.
     * @deny (update) User cannot update another user's product.
     * @deny (delete) User cannot delete another user's product.
     * @principle Allows public read access but enforces ownership for writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);

      function isExistingOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId && resource != null;
      }
    }

    /**
     * @description Orders are publicly readable but only modifiable by the buyer or seller.
     * @path /orders/{orderId}
     * @allow (get) Any user can read an order.
     * @allow (list) Any user can list orders.
     * @allow (create) No direct client-side creation.
     * @allow (update) No direct client-side updates.
     * @allow (delete) No direct client-side deletion.
     * @principle No write operations permitted from the client side.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Payments are publicly readable, but should only be created and modified by trusted services.
     * @path /payments/{paymentId}
     * @allow (get) Any user can read payment information.
     * @allow (list) Any user can list payments.
     * @allow (create) Not allowed from client side.
     * @allow (update) Not allowed from client side.
     * @allow (delete) Not allowed from client side.
     * @principle Prevents unauthorized manipulation of payment records.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Subscription plans are publicly accessible and read-only.
     * @path /plans/{planId}
     * @allow (get) Any user can read a plan.
     * @allow (list) Any user can list plans.
     * @allow (create) Not allowed from client side.
     * @allow (update) Not allowed from client side.
     * @allow (delete) Not allowed from client side.
     * @principle Provides public access to plan information while preventing unauthorized changes.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Call records are publicly readable, but modifications are restricted.
     * @path /calls/{callId}
     * @allow (get) Any user can read a call record.
     * @allow (list) Any user can list call records.
     * @allow (create) Not allowed from client side.
     * @allow (update) Not allowed from client side.
     * @allow (delete) Not allowed from client side.
     * @principle Prevents unauthorized changes to call session data.
     */
    match /calls/{callId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to transactions based on ownership or admin privileges.
     * @path /transactions/{txId}
     * @allow (get) Admin (by email) can read all docs. Normal user can read ONLY docs where resource.data.uid == their uid.
     * @allow (list) Admin (by email) can list all docs. Normal user can list ONLY docs where resource.data.uid == their uid.
     * @allow (create) User may create only their own transaction.
     * @deny (update) No client updates allowed.
     * @deny (delete) No client deletes allowed.
     * @principle Restricts access to transactions based on ownership or admin status.
     */
    match /transactions/{txId} {
      allow get, list: if isSignedIn() &&
        (
          request.auth.token.email == "blagridigital@gmail.com" ||
          resource.data.uid == request.auth.uid
        );

      allow create: if isSignedIn() &&
        request.resource.data.uid == request.auth.uid;

      allow update, delete: if false;
    }

    /**
     * @description Restricts access to admin settings.
     * @path /adminSettings/{settingId}
     * @allow (get) No client get allowed.
     * @allow (list) No client list allowed.
     * @allow (create) No client create allowed.
     * @allow (update) No client updates allowed.
     * @allow (delete) No client deletes allowed.
     */
    match /adminSettings/{settingId} {
        allow get, list, create, update, delete: if false;
    }

    /**
     * @description Restricts access to admin agents.
     * @path /adminAgents/{agentId}
     * @allow (get) No client get allowed.
     * @allow (list) No client list allowed.
     * @allow (create) No client create allowed.
     * @allow (update) No client updates allowed.
     * @allow (delete) No client deletes allowed.
     */
    match /adminAgents/{agentId} {
        allow get, list, create, update, delete: if false;
    }


    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param {string} userId The user ID to check.
     * @return {bool} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
  }
}