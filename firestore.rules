/**
 * @fileOverview Firestore Security Rules for AkiliPesa application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data
 * and public read access for general content. It prioritizes security and
 * data integrity by validating ownership and preventing unauthorized data
 * access. Admin access is granted via email.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}, enforcing ownership.
 * - Public content (posts, products) is stored in top-level collections.
 * - Transactions are stored in a top-level collection with user-specific filtering.
 *
 * Key Security Decisions:
 * - Users can only access their own profiles and associated data.
 * - Public content is readable by all, but only modifiable by the owner.
 * - Listing all users is disallowed for privacy.
 * - Admin settings are only accessible to authenticated admins.
 *
 * Denormalization for Authorization:
 * - Many entities have an `ownerId` or `authorId` field to simplify ownership checks
 *   and avoid costly `get()` operations. For example, Posts have `authorId`.
 *
 * Structural Segregation:
 * - Public posts are stored in the top-level `/posts` collection, while private
 *   user data resides under `/users/{userId}`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare with the authenticated user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource, and that the resource exists.
     * @param {string} userId The user ID to compare with the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is an admin.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (get, update, delete) if isOwner(userId) - Allows the owner to read, update, and delete their profile.
     * @allow (create) if isOwner(userId) - Allows the owner to create their profile.
     * @allow (list) if false - Disallows listing all users.
     * @deny (create) if request.resource.data.uid != request.auth.uid - Denies creating if the uid doesn't match the auth uid.
     * @deny (update) if request.resource.data.uid != resource.data.uid - Denies updating the uid.
     * @principle Enforces document ownership and prevents unauthorized access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for all posts.
     * @path /posts/{postId}
     * @allow (get, list) if true - Allows anyone to read and list all posts.
     * @allow (create) if request.auth != null && request.resource.data.authorId == request.auth.uid - Allows only authenticated users to create posts with matching authorId.
     * @allow (update, delete) if request.auth != null && resource.data.authorId == request.auth.uid - Allows only the author to update and delete their posts.
     * @deny (create) if request.resource.data.authorId == null - Denies creating a post if no authorId is specified.
     * @principle Allows public read access with owner-only writes.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Rules for user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (get, list, create, update, delete) if isOwner(userId) - Allows the owner to manage their clones.
     * @principle Enforces document ownership and prevents unauthorized access.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user-specific AI agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (get, list, create, update, delete) if isOwner(userId) - Allows the owner to manage their agents.
     * @principle Enforces document ownership and prevents unauthorized access.
     */
    match /users/{userId}/agents/{agentId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for all products.
     * @path /products/{productId}
     * @allow (get, list) if true - Allows anyone to read and list all products.
     * @allow (create) if request.auth != null && request.resource.data.ownerId == request.auth.uid - Allows only authenticated users to create products with matching ownerId.
     * @allow (update, delete) if request.auth != null && resource.data.ownerId == request.auth.uid - Allows only the owner to update and delete their products.
     * @deny (create) if request.resource.data.ownerId == null - Denies creating a product if no ownerId is specified.
     * @principle Allows public read access with owner-only writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Rules for all orders.
     * @path /orders/{orderId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update, delete: if false;
     * @principle Public read access, authenticated create, no updates or deletes.
     */
    match /orders/{orderId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Rules for all payments.
     * @path /payments/{paymentId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update, delete: if false;
     * @principle Public read access, authenticated create, no updates or deletes.
     */
    match /payments/{paymentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Rules for subscription plans.
     * @path /plans/{planId}
     * @allow get, list: if true - Allows anyone to read and list subscription plans.
     * @allow create, update, delete: if false - Prevents anyone from creating, updating, or deleting plans.
     * @principle Public read-only access for subscription plans.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for call sessions.
     * @path /calls/{callId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update, delete: if false;
     * @principle Public read access, authenticated create, no updates or deletes.
     */
    match /calls/{callId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Rules for transactions.
     * @path /transactions/{txId}
     * @allow get, list: if request.auth != null && (request.auth.token.email == "blagridigital@gmail.com" || resource.data.uid == request.auth.uid) - Allows admin or the owner to read and list transactions.
     * @allow create: if request.auth != null && request.resource.data.uid == request.auth.uid - Allows the owner to create a transaction.
     * @allow update, delete: if false - Prevents anyone from updating or deleting transactions.
     * @principle Allows admin and owner access with authenticated create.
     */
    match /transactions/{txId} {
      allow get, list: if isSignedIn() && (isAdmin() || resource.data.uid == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Rules for admin settings.
     * @path /adminSettings/{settingId}
     * @allow get: if isAdmin() - Allows only admins to read admin settings.
     * @allow list: if false;
     * @allow create, update, delete: if false - Prevents anyone from creating, updating, or deleting admin settings.
     * @principle Restricts access to admin settings to admins only.
     */
    match /adminSettings/{settingId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for admin-created AI agents.
     * @path /adminAgents/{agentId}
     * @allow get, list: if isAdmin() - Allows only admins to read and list admin agents.
     * @allow create: if isAdmin() - Allows admins to create agents.
     * @allow update, delete: if isAdmin() - Allows admins to update and delete agents.
     * @principle Restricts access to admin agents to admins only.
     */
    match /adminAgents/{agentId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}