/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a combination of user-ownership and public-read/owner-write access patterns.
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}.
 * - User-specific clones and agents are stored under /users/{userId}/clones/{cloneId} and /users/{userId}/agents/{agentId} respectively.
 * - Public posts are stored under /posts/{postId}.
 * - Products, orders, payments, plans, calls, transactions, admin settings, and admin agents are stored in top-level collections.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profiles, clones, and agents.
 * - Posts are publicly readable, but only the owner can modify them.
 * - Listing of admin agents is disallowed, as it is likely to contain proprietary data.
 * - Other top-level collections (products, orders, payments, plans, calls, transactions, admin settings) have open read access.
 *
 * Denormalization for Authorization:
 * - Posts must contain an `authorId` field to identify the owner. This is required for owner-only write access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a profile document where userId == 'user123'.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, and delete their profile document at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile document for userId 'user123'.
     * @deny (update, delete) - User with UID 'user456' cannot update or delete the profile document at /users/user123.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows public reading of posts, but only the author can modify them.
     * @path /posts/{postId}
     * @allow (get, list) - Any user (or no user) can read posts.
     * @allow (create) - User with UID 'user123' can create a post where request.resource.data.authorId == 'user123'.
     * @allow (update, delete) - User with UID 'user123' can update and delete their own post where resource.data.authorId == 'user123'.
     * @deny (create) - User with UID 'user456' cannot create a post where request.resource.data.authorId == 'user123'.
     * @deny (update, delete) - User with UID 'user456' cannot update or delete a post where resource.data.authorId == 'user123'.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Allows users to manage their own digital clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) - User with UID 'user123' can create a clone document under their user ID.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, and delete their own clone document.
     * @deny (create) - User with UID 'user456' cannot create a clone document under /users/user123.
     * @deny (update, delete) - User with UID 'user456' cannot update or delete the clone document under /users/user123.
     * @principle Enforces document ownership, restricts access to a user's own data.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own AI agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) - User with UID 'user123' can create an agent document under their user ID.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, and delete their own agent document.
     * @deny (create) - User with UID 'user456' cannot create an agent document under /users/user123.
     * @deny (update, delete) - User with UID 'user456' cannot update or delete the agent document under /users/user123.
     * @principle Enforces document ownership, restricts access to a user's own data.
     */
    match /users/{userId}/agents/{agentId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows public reading of products.  Writes are not currently secured.
     * @path /products/{productId}
     * @allow (get, list) - Any user (or no user) can read product information.
     * @principle Public read access.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of orders.  Writes are not currently secured.
     * @path /orders/{orderId}
     * @allow (get, list) - Any user (or no user) can read order information.
     * @principle Public read access.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of payments.  Writes are not currently secured.
     * @path /payments/{paymentId}
     * @allow (get, list) - Any user (or no user) can read payment information.
     * @principle Public read access.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of plans.  Writes are not currently secured.
     * @path /plans/{planId}
     * @allow (get, list) - Any user (or no user) can read plan information.
     * @principle Public read access.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of calls.  Writes are not currently secured.
     * @path /calls/{callId}
     * @allow (get, list) - Any user (or no user) can read call information.
     * @principle Public read access.
     */
    match /calls/{callId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of transactions. Writes are not currently secured.
     * @path /transactions/{txId}
     * @allow (get, list) - Any user (or no user) can read transaction information.
     * @principle Public read access.
     */
    match /transactions/{txId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public reading of admin settings.  Writes are not currently secured.
     * @path /adminSettings/{settingId}
     * @allow (get, list) - Any user (or no user) can read admin settings.
     * @principle Public read access.
     */
    match /adminSettings/{settingId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Denies listing of admin agents. Other operations are not currently secured.
     * @path /adminAgents/{agentId}
     * @deny (list) - No one can list admin agents.
     * @principle Restricts access to sensitive data.
     */
    match /adminAgents/{agentId} {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if false; // TODO: Add owner/admin validation once the schema and access control are clarified.
    }

  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
  }
}