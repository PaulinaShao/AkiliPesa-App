/**
 * @description This ruleset enforces a strict user-ownership model for user-specific data and allows public read access for certain collections while restricting write access to authorized users.
 * @dataStructure
 * - Users have their own profiles stored under `/users/{userId}`.
 * - Users can create posts stored under `/posts/{postId}`.
 * - Users can create digital clones stored under `/users/{userId}/clones/{cloneId}`.
 * - Users can create AI agents stored under `/users/{userId}/agents/{agentId}`.
 * - Products are stored under `/products/{productId}` and are publicly accessible for reading.
 * - Orders are stored under `/orders/{orderId}`.
 * - Payments are stored under `/payments/{paymentId}`.
 * - Plans are stored under `/plans/{planId}` and are publicly accessible for reading.
 * - Calls are stored under `/calls/{callId}`.
 * - Transactions are stored under `/transactions/{txId}`.
 * - Admin settings are stored under `/adminSettings/{settingId}`.
 * - Admin agents are stored under `/adminAgents/{agentId}` and are publicly accessible for reading.
 * - Notifications are stored under `/notifications/{notificationId}`.
 * @keySecurityDecisions
 * - User listing is disallowed.
 * - Public read access is granted to the `/products`, `/plans`, and `/adminAgents` collections.
 * - Ownership is enforced for all user-specific data.
 * @denormalizationForAuthorization
 * - The `/notifications/{notificationId}` documents denormalize the `uid` field to represent the user who receives the notification. This allows for efficient authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profiles. Users can only read and write their own profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their profile if the userId matches their auth UID.
     * @allow (get, list, update, delete) - Authenticated user can access their profile if the userId matches their auth UID.
     * @deny (create) - If the userId does not match the authenticated user's UID.
     * @deny (get, list, update, delete) - If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to all posts. Users can create posts, and only the post owner can update or delete them.
     * @path /posts/{postId}
     * @allow (get, list) - Any user can read any post.
     * @allow (create) - An authenticated user can create a post. The authorId field must match the authenticated user's UID.
     * @allow (update, delete) - Only the post owner can update or delete a post.
     * @deny (create) - If the authorId does not match the authenticated user's UID.
     * @deny (update, delete) - If the user is not the post owner or the post doesn't exist.
     * @principle Public read access with owner-only writes, enforces document ownership for writes.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Grants access to user-specific clones. Users can only read and write their own clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) - Authenticated user can create a clone if the userId matches their auth UID.
     * @allow (get, list, update, delete) - Authenticated user can access their clone if the userId matches their auth UID.
     * @deny (create) - If the userId does not match the authenticated user's UID.
     * @deny (get, list, update, delete) - If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to user-specific agents. Users can only read and write their own agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) - Authenticated user can create an agent if the userId matches their auth UID.
     * @allow (get, list, update, delete) - Authenticated user can access their agent if the userId matches their auth UID.
     * @deny (create) - If the userId does not match the authenticated user's UID.
     * @deny (get, list, update, delete) - If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/agents/{agentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants public read access to products, but restricts write access to the product owner.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read any product.
     * @allow (create) - An authenticated user can create a product. The ownerId field must match the authenticated user's UID.
     * @allow (update, delete) - Only the product owner can update or delete a product.
     * @deny (create) - If the ownerId does not match the authenticated user's UID.
     * @deny (update, delete) - If the user is not the product owner or the product doesn't exist.
     * @principle Public read access with owner-only writes, enforces document ownership for writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Grants access to orders. Only the buyer or seller can read an order, and only authorized users can create, update, or delete orders.
     * @path /orders/{orderId}
     * @allow (get) - If the user is the buyer or the seller.
     * @allow (list) - No listing.
     * @allow (create) - An authenticated user can create.
     * @allow (update) - An authenticated user can update.
     * @allow (delete) - An authenticated user can delete.
     * @deny (get) - If the user is neither the buyer nor the seller.
     * @deny (create, update, delete) - If the user is not authenticated.
     * @principle Enforces document ownership for reads and requires authentication for writes.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
    }

    /**
     * @description Grants access to payments. Only the seller can read a payment, and only authorized users can create, update, or delete payments.
     * @path /payments/{paymentId}
     * @allow (get) - If the user is the seller.
     * @allow (list) - No listing.
     * @allow (create) - An authenticated user can create.
     * @allow (update) - An authenticated user can update.
     * @allow (delete) - An authenticated user can delete.
     * @deny (get) - If the user is not the seller.
     * @deny (create, update, delete) - If the user is not authenticated.
     * @principle Enforces document ownership for reads and requires authentication for writes.
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Grants public read access to plans. Write access is denied.
     * @path /plans/{planId}
     * @allow (get, list) - Any user can read any plan.
     * @deny (create, update, delete) - No user can create, update, or delete a plan.
     * @principle Public read access with no writes.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to calls. Only the caller or agent can read a call, and only authorized users can create, update, or delete calls.
     * @path /calls/{callId}
     * @allow (get) - If the user is the caller or the agent.
     * @allow (list) - No listing.
     * @allow (create) - An authenticated user can create.
     * @allow (update) - An authenticated user can update.
     * @allow (delete) - An authenticated user can delete.
     * @deny (get) - If the user is neither the caller nor the agent.
     * @deny (create, update, delete) - If the user is not authenticated.
     * @principle Enforces document ownership for reads and requires authentication for writes.
     */
    match /calls/{callId} {
      allow get: if isSignedIn() && (resource.data.callerId == request.auth.uid || resource.data.agentId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.callerId == request.auth.uid || resource.data.agentId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.callerId == request.auth.uid || resource.data.agentId == request.auth.uid);
    }

    /**
     * @description Grants access to transactions. Only the user can read their own transactions, and only authorized users can create, update, or delete transactions.
     * @path /transactions/{txId}
     * @allow (get) - If the user is the owner.
     * @allow (list) - No listing.
     * @allow (create) - An authenticated user can create.
     * @allow (update) - An authenticated user can update.
     * @allow (delete) - An authenticated user can delete.
     * @deny (get) - If the user is not the owner.
     * @deny (create, update, delete) - If the user is not authenticated.
     * @principle Enforces document ownership for reads and requires authentication for writes.
     */
    match /transactions/{txId} {
      allow get: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    /**
     * @description Grants access to admin settings. Read and write access is denied.
     * @path /adminSettings/{settingId}
     * @deny (get, list, create, update, delete) - No one can read or write admin settings.
     * @principle No access granted.
     */
    match /adminSettings/{settingId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants public read access to admin agents. Write access is denied.
     * @path /adminAgents/{agentId}
     * @allow (get, list) - Any user can read any admin agent.
     * @deny (create, update, delete) - No user can create, update, or delete an admin agent.
     * @principle Public read access with no writes.
     */
    match /adminAgents/{agentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to notifications. Users can only read and write their own notifications.
     * @path /notifications/{notificationId}
     * @allow (read) - Authenticated user can read if the notification belongs to them.
     * @allow (update) - Authenticated user can update the isRead flag if the notification belongs to them.
     * @allow (create) - Authenticated user can create if the userId matches their auth UID.
     * @deny (create) - If the userId does not match the authenticated user's UID.
     * @deny (read, update) - If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for all operations.
     */
    match /notifications/{notificationId} {
      allow get: if request.auth.uid == resource.data.uid;
      allow list: if false;
      allow create: if request.auth.uid == request.resource.data.uid;
      allow update: if request.auth.uid == resource.data.uid && request.resource.data.isRead == true && resource != null;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId && resource != null;
    }
  }
}