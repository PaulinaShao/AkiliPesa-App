/**
 * @fileOverview Firestore Security Rules for AkiliPesa's AI-Driven Seller Scoring & Trust Profile System (Phase 9).
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization based on user identity and explicit ownership.
 * It focuses on securing access to user-specific data and preventing unauthorized modifications.
 * Data validation is relaxed to facilitate rapid prototyping, with key relational fields strictly enforced.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`.
 * - User-generated content is stored under `/posts/{postId}`.
 * - Trust scores are stored under `/trustScores/{sellerId}`.
 * - Feedback data is stored under `/feedback/{id}`.
 * - Trust history is stored under `/trustHistory/{id}`.
 *
 * Key Security Decisions:
 * - Users can only access and modify their own profile data.
 * - Posts are publicly readable but writable only by the author.
 * - Trust scores are readable by authenticated users, but only writable by a specific admin.
 * - Feedback can only be created by authenticated users.
 * - Admin settings are only readable by admins.
 * - User listing is disabled for security reasons.
 *
 * Denormalization for Authorization:
 * - The `feedback` documents contain `sellerId` and `buyerId`, enabling direct authorization checks without additional `get()` calls.
 *
 * Structural Segregation:
 * - There are no specific drafts vs. published distinctions, but the separation of user-specific data under `/users/{userId}` enhances privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of the resource and the resource exists.
     * @param {string} userId - The user ID to compare against the resource's owner ID.
     * @returns {boolean} True if the user is the existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user has the admin role.
     * @returns {boolean} True if the user has the admin role, false otherwise.
     */
    function isAdmin() {
      return request.auth.token.email == "blagridigital@gmail.com";
    }

    /**
     * @description Rule for user profiles.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @allow (get) User with UID 'user123' can get their profile if request.auth.uid == 'user123'.
     * @allow (update) User with UID 'user123' can update their profile if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a profile for 'user123' if request.auth.uid != 'user123'.
     * @deny (update) User with UID 'user456' cannot update the profile of 'user123' if request.auth.uid != 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for user posts.
     * @path /posts/{postId}
     * @allow (create) User with UID 'user123' can create a post with authorId 'user123'.
     * @allow (get) Any user can read any post.
     * @allow (update) User with UID 'user123' can update their own post (resource.data.authorId == request.auth.uid).
     * @deny (create) User with UID 'user456' cannot create a post with authorId 'user123'.
     * @deny (update) User with UID 'user456' cannot update a post authored by 'user123'.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Rule for user clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) User with UID 'user123' can create a clone under their profile.
     * @allow (get) User with UID 'user123' can read their own clone data.
     * @allow (update) User with UID 'user123' can update their clone data.
     * @deny (create) User with UID 'user456' cannot create a clone under 'user123' profile.
     * @deny (update) User with UID 'user456' cannot update clones under 'user123' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for user agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) User with UID 'user123' can create an agent under their profile.
     * @allow (get) User with UID 'user123' can read their agent data.
     * @allow (update) User with UID 'user123' can update their agent data.
     * @deny (create) User with UID 'user456' cannot create an agent under 'user123' profile.
     * @deny (update) User with UID 'user456' cannot update agents under 'user123' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/agents/{agentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for products.
     * @path /products/{productId}
     * @allow (get) Any user can read product data.
     * @allow (list) Any user can list products.
     * @allow (create) User with UID 'user123' can create a product with ownerId 'user123'.
     * @allow (update) User with UID 'user123' can update their own product (resource.data.ownerId == request.auth.uid).
     * @deny (create) User with UID 'user456' cannot create a product with ownerId 'user123'.
     * @deny (update) User with UID 'user456' cannot update a product owned by 'user123'.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Rule for orders.
     * @path /orders/{orderId}
     * @allow (get) Any user can read order data.
     * @allow (list) Any user can list orders.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /orders/{orderId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for payments.
     * @path /payments/{paymentId}
     * @allow (get) Any user can read payment data.
     * @allow (list) Any user can list payments.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /payments/{paymentId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for plans.
     * @path /plans/{planId}
     * @allow (get) Any user can read plan data.
     * @allow (list) Any user can list plans.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for calls.
     * @path /calls/{callId}
     * @allow (get) Any user can read call data.
     * @allow (list) Any user can list calls.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /calls/{callId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for transactions.
     * @path /transactions/{txId}
     * @allow (get) Any user can read transaction data.
     * @allow (list) Any user can list transactions.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /transactions/{txId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for admin settings.
     * @path /adminSettings/{settingId}
     * @allow (get) Only admins can read admin settings.
     * @allow (list) Only admins can list admin settings.
     * @allow create: if isAdmin();
     * @allow update: if isAdmin();
     * @allow delete: if isAdmin();
     * @principle Restricts access to admins only.
     */
    match /adminSettings/{settingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for admin agents.
     * @path /adminAgents/{agentId}
     * @allow (get) Only admins can read admin agent data.
     * @allow (list) Only admins can list admin agents.
     * @allow create: if isAdmin();
     * @allow update: if isAdmin();
     * @allow delete: if isAdmin();
     */
    match /adminAgents/{agentId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for trust scores.
     * @path /trustScores/{sellerId}
     * @allow (get) Authenticated users can read trust scores.
     * @allow (list) Authenticated users can list trust scores.
     * @allow (create) Only admins can create trust scores.
     * @allow (update) Only admins can update trust scores.
     * @allow (delete) Only admins can delete trust scores.
     */
    match /trustScores/{sellerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for feedback.
     * @path /feedback/{id}
     * @allow (create) Authenticated users can create feedback.
     *
     * @allow (get) Authenticated users can read feedback if they are the seller or buyer.
     * @allow (list) Authenticated users can list feedback if they are the seller or buyer.
     *
     * @deny (update) No one can update feedback.
     * @deny (delete) No one can delete feedback.
     */
    match /feedback/{id} {
      allow get: if isSignedIn() && (request.auth.uid == resource.data.sellerId || request.auth.uid == resource.data.buyerId);
      allow list: if isSignedIn() && (request.auth.uid == resource.data.sellerId || request.auth.uid == resource.data.buyerId);
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for trust history.
     * @path /trustHistory/{id}
     * @allow (get) Authenticated users can read trust history.
     * @allow (list) Authenticated users can list trust history.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /trustHistory/{id} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}