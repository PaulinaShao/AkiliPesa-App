/**
 * @description This ruleset enforces a strict user-ownership model for user-specific data and allows public read access to some collections while restricting write access to authorized users.
 * @dataStructure
 *  - /users/{userId}: Stores user profiles. Accessible only by the user themselves.
 *  - /posts/{postId}: Stores all user posts. Publicly readable, but write access is restricted to the post's author.
 *  - /users/{userId}/clones/{cloneId}: Stores user-specific digital clones. Accessible only by the owning user.
 *  - /users/{userId}/agents/{agentId}: Stores user-specific AI agents. Accessible only by the owning user.
 *  - /products/{productId}: Stores all products and services. Publicly readable, but write access is restricted to the product's owner.
 *  - /orders/{orderId}: Stores all orders.  Write access is not available, but all the document can be accessed.
 *  - /payments/{paymentId}: Stores all payment and commission data.
 *  - /plans/{planId}: Stores available subscription plans. Publicly readable.
 *  - /calls/{callId}: Stores active and past call sessions.
 *  - /transactions/{txId}: Stores a log of all financial transactions.
 *  - /adminSettings/{settingId}: Stores global admin settings.
 *  - /adminAgents/{agentId}: Stores admin-created AI agents. Publicly readable.
 * @keySecurityDecisions
 *  - User data is strictly controlled by the user's ID.
 *  - Public collections like 'posts' and 'products' are readable by everyone, but write access is limited to the owner.
 *  - Listing of 'adminAgents' collection is denied for all users as per the error report.
 * @denormalizationForAuthorization
 *  - For 'posts' and 'products', the 'authorId' and 'ownerId' fields, respectively, are used to enforce owner-only write access. These fields must exist in the document for the rules to function correctly.
 * @structuralSegregation
 *  - User-specific private data (clones, agents) is stored under the /users/{userId} path, separate from public data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create a profile with document ID 'user123'.
     * @allow (get) User with UID 'user123' can read their own profile data at /users/user123.
     * @allow (update) User with UID 'user123' can update their own profile data at /users/user123.
     * @deny (create) User with UID 'user456' cannot create a profile with document ID 'user123'.
     * @deny (get) User with UID 'user456' cannot read profile data at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && resource.data.uid == userId;
      allow delete: if isOwner(userId) && resource.data.uid == userId;
    }

    /**
     * @description Allows anyone to read posts, but only the author can create, update, or delete them.
     * @path /posts/{postId}
     * @allow (get) Any user can read any post.
     * @allow (list) Any user can list posts.
     * @allow (create) User with UID 'user123' can create a post with authorId 'user123'.
     * @deny (create) User with UID 'user456' cannot create a post with authorId 'user123'.
     * @deny (update) User with UID 'user456' cannot update a post with authorId 'user123'.
     * @principle Public read access with owner-only writes.
     */
    match /posts/{postId} {
      function isOwner(authorId) {
        return request.auth != null && request.auth.uid == authorId;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update: if isOwner(resource.data.authorId) && resource != null;
      allow delete: if isOwner(resource.data.authorId) && resource != null;
    }

    /**
     * @description Allows a user to manage their own digital clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) User with UID 'user123' can create a clone under /users/user123/clones/clone123.
     * @allow (get) User with UID 'user123' can read their own clone data.
     * @deny (create) User with UID 'user456' cannot create a clone under /users/user123/clones/clone123.
     * @deny (get) User with UID 'user456' cannot read clone data under /users/user123/clones/clone123.
     * @principle Enforces document ownership for all operations within the user's data tree.
     */
    match /users/{userId}/clones/{cloneId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Allows a user to manage their own AI agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) User with UID 'user123' can create an agent under /users/user123/agents/agent123.
     * @allow (get) User with UID 'user123' can read their own agent data.
     * @deny (create) User with UID 'user456' cannot create an agent under /users/user123/agents/agent123.
     * @deny (get) User with UID 'user456' cannot read agent data under /users/user123/agents/agent123.
     * @principle Enforces document ownership for all operations within the user's data tree.
     */
    match /users/{userId}/agents/{agentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read products, but only the owner can create, update, or delete them.
     * @path /products/{productId}
     * @allow (get) Any user can read any product.
     * @allow (list) Any user can list products.
     * @allow (create) User with UID 'user123' can create a product with ownerId 'user123'.
     * @deny (create) User with UID 'user456' cannot create a product with ownerId 'user123'.
     * @deny (update) User with UID 'user456' cannot update a product with ownerId 'user123'.
     * @principle Public read access with owner-only writes.
     */
    match /products/{productId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if isOwner(resource.data.ownerId) && resource != null;
      allow delete: if isOwner(resource.data.ownerId) && resource != null;
    }

    /**
     * @description Allows anyone to read orders
     * @path /orders/{orderId}
     * @allow (get) Any user can read any order.
     * @allow (list) Any user can list orders.
     * @deny (create) Nobody can create orders.
     * @deny (update) Nobody can update orders.
     */
    match /orders/{orderId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read payments
     * @path /payments/{paymentId}
     * @allow (get) Any user can read any payment.
     * @allow (list) Any user can list payments.
     * @deny (create) Nobody can create payments.
     * @deny (update) Nobody can update payments.
     */
    match /payments/{paymentId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read plans
     * @path /plans/{planId}
     * @allow (get) Any user can read any plan.
     * @allow (list) Any user can list plans.
     * @deny (create) Nobody can create plans.
     * @deny (update) Nobody can update plans.
     */
    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read calls
     * @path /calls/{callId}
     * @allow (get) Any user can read any call.
     * @allow (list) Any user can list calls.
     * @deny (create) Nobody can create calls.
     * @deny (update) Nobody can update calls.
     */
    match /calls/{callId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read transactions
     * @path /transactions/{txId}
     * @allow (get) Any user can read any transaction.
     * @allow (list) Any user can list transactions.
     * @deny (create) Nobody can create transactions.
     * @deny (update) Nobody can update transactions.
     */
    match /transactions/{txId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read admin settings
     * @path /adminSettings/{settingId}
     * @allow (get) Any user can read any admin setting.
     * @allow (list) Any user can list admin settings.
     * @deny (create) Nobody can create admin settings.
     * @deny (update) Nobody can update admin settings.
     */
    match /adminSettings/{settingId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

      /**
       * @description Denies listing of admin agents.
       * @path /adminAgents/{agentId}
       * @deny (list) No user can list admin agents.
       * @allow (get) Any user can get any admin agent.
       * @principle Restricts listing of admin agents for security.
       */
    match /adminAgents/{agentId} {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}