/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for most data, with some public read access for specific collections.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`.
 * - User-generated content (clones, agents) are stored under `/users/{userId}/clones/{cloneId}` and `/users/{userId}/agents/{agentId}` respectively.
 * - Public posts are stored under `/posts/{postId}`.
 * - Products are stored under `/products/{productId}`.
 * - Orders are stored under `/orders/{orderId}`.
 * - Payments are stored under `/payments/{paymentId}`.
 * - Plans are stored under `/plans/{planId}`.
 * - Calls are stored under `/calls/{callId}`.
 * - Transactions are stored under `/transactions/{txId}`.
 * - Admin settings are stored under `/adminSettings/{settingId}`.
 * - Admin agents are stored under `/adminAgents/{agentId}`.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Most collections enforce strict ownership; a user can only access their own data.
 * - The `posts` collection allows public reads but restricts writes to the owner.
 * - Read/write permissions are explicitly defined for each collection.
 *
 * Denormalization for Authorization:
 * - The 'posts' collection requires an `authorId` field to match `request.auth.uid` for write operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read their own profile and create/update their profile if authenticated and the userId matches their auth UID.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read any user profile.
     * @allow (create, update) Authenticated user with matching UID can create/update their own profile.
     * @deny (delete, list) All delete and list operations are denied.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if true;
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete, list: if false;
    }

    /**
     * @description Allows anyone to read posts, but only the owner can create, update, or delete.
     * @path /posts/{postId}
     * @allow (get, list) Anyone can read or list posts.
     * @allow (create) Authenticated user can create a post if authorId matches their auth UID.
     * @allow (update, delete) Authenticated user can update/delete a post if they are the author.
     * @deny If the authorId in the request does not match the authenticated user's UID.
     * @principle Public read, owner-only writes with author ID validation.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Allows a user to manage their own clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (get, list) Authenticated user can read/list their own clones.
     * @allow (create) Authenticated user can create clones under their UID.
     * @allow (update, delete) Authenticated user can update/delete their own clones.
     * @deny Operations by other users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (get, list) Authenticated user can read/list their own agents.
     * @allow (create) Authenticated user can create agents under their UID.
     * @allow (update, delete) Authenticated user can update/delete their own agents.
     * @deny Operations by other users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/agents/{agentId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows read access to products, but restricts creation, updates, and deletion.
     * @path /products/{productId}
     * @allow (get, list) Anyone can read or list products.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to orders, but restricts creation, updates, and deletion.
     * @path /orders/{orderId}
     * @allow (get, list) Anyone can read or list orders.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to payments, but restricts creation, updates, and deletion.
     * @path /payments/{paymentId}
     * @allow (get, list) Anyone can read or list payments.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to plans, but restricts creation, updates, and deletion.
     * @path /plans/{planId}
     * @allow (get, list) Anyone can read or list plans.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to calls, but restricts creation, updates, and deletion.
     * @path /calls/{callId}
     * @allow (get, list) Anyone can read or list calls.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /calls/{callId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Transactions can be read if the user is the owner, and created if the user is authenticated and the uid matches their auth UID.
     * @path /transactions/{txId}
     * @allow (get) Authenticated user can read if they are the owner of the transaction.
     * @allow (create) Authenticated user can create a transaction with their UID.
     * @deny (update, delete, list) All update, delete, and list operations are denied.
     * @principle Enforces document ownership for reads and creation.
     */
    match /transactions/{txId} {
      allow get: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete, list: if false;
    }

    /**
     * @description Allows read access to admin settings, but restricts creation, updates, and deletion.
     * @path /adminSettings/{settingId}
     * @allow (get, list) Anyone can read or list admin settings.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /adminSettings/{settingId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to admin agents, but restricts creation, updates, and deletion.
     * @path /adminAgents/{agentId}
     * @allow (get, list) Anyone can read or list admin agents.
     * @allow (create, update, delete) if false.
     * @principle Read-only for all users, no write access.
     */
    match /adminAgents/{agentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows users to read/create/update their own wallet if authenticated and the userId matches their auth UID.
     * @path /wallets/{userId}
     * @allow (get, create, update) Authenticated user with matching UID can read/create/update their own wallet.
     * @deny (delete, list) All delete and list operations are denied.
     * @principle Enforces document ownership for all operations.
     */
    match /wallets/{userId} {
      allow get, create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete, list: if false;
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document based on the userId.
     * @param {string} userId - The user ID to check against the request auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the document and if the document exists.
     * @param {string} userId - The user ID to check against the resource data.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && request.auth.uid == userId && resource != null;
    }
  }
}