/**
 * @fileoverview Firestore Security Rules.
 *
 * Core Philosophy: This ruleset prioritizes strong authorization based on
 * user identity and explicit ownership. It leans towards permissive data
 * validation for rapid prototyping, focusing on preventing unauthorized
 * access rather than enforcing strict data schemas.
 *
 * Data Structure:
 * - Users: Profiles are stored under /users/{userId}.
 * - Posts: Publicly readable posts are stored in /posts/{postId}.
 * - Clones & Agents: User-owned resources under /users/{userId}/clones/{cloneId} and /users/{userId}/agents/{agentId}.
 * - Products, Orders, Payments, Plans: Top-level collections with specific authorization schemes.
 *
 * Key Security Decisions:
 * - User profiles are publicly readable but only editable by the owner.
 * - Posts are publicly readable but only creatable by authenticated users, and editable/deletable by the author.
 * - Clones and Agents are strictly user-owned.
 * - Payments are writable only by backend functions to ensure integrity.
 * - Listing of user subcollections (clones, agents) is allowed only by the owner.
 *
 * Denormalization for Authorization:
 * - Posts: The `posts` documents MUST contain `authorId` field to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isFunction() {
        return request.auth.token.firebase.sign_in_provider == "custom" && request.auth.token.admin == true;
    }

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (read) Any user can read any profile.
     * @allow (create, update) Only the user can create or update their own profile.
     * @deny (delete) No one can delete a user profile through the rules.
     * @principle Enforces user-ownership for profile modification.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Controls access to posts.
     * @path /posts/{postId}
     * @allow (read) Any user can read any post.
     * @allow (create) Any authenticated user can create a post. The `authorId` field must match the authenticated user's ID.
     * @allow (update, delete) Only the author of the post can update or delete it, with verification that the document exists.
     * @deny Mismatched authorId on create, or unauthorized edits/deletions.
     * @principle Allows public read access, but restricts write access to authenticated owners.
     */
    match /posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Controls access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (read, list) Only the owner can read or list their own clones.
     * @allow (create, update, delete) Only the owner can create, update, or delete their own clones, with verification that the document exists for update and delete.
     * @deny Mismatched user ID, or unauthorized writes.
     * @principle Enforces strict user-ownership for clone data.
     */
    match /users/{userId}/clones/{cloneId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to user-specific AI agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (read, list) Only the owner can read or list their own agents.
     * @allow (create, update, delete) Only the owner can create, update, or delete their own agents, with verification that the document exists for update and delete.
     * @deny Mismatched user ID, or unauthorized writes.
     * @principle Enforces strict user-ownership for agent data.
     */
    match /users/{userId}/agents/{agentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to products.
     * @path /products/{productId}
     * @allow (read) Any user can read any product.
     * @allow (create, update, delete) Any authenticated user can create, update or delete a product.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to orders.
     * @path /orders/{orderId}
     * @allow (read, create) Any authenticated user can read or create an order.
     * @allow (update) Any authenticated user can update an order.
     * @deny Unauthorized writes.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Controls access to payments.
     * @path /payments/{paymentId}
     * @allow (read) Any authenticated user can read a payment.
     * @allow (create, update, delete) Only backend functions can create, update, or delete payments.
     * @deny Unauthorized writes.
     * @principle Enforces that only backend functions can modify payment data.
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isFunction();
      allow update: if isFunction();
      allow delete: if isFunction();
    }

    /**
     * @description Controls access to plans.
     * @path /plans/{planId}
     * @allow (read) Any user can read any plan.
     * @deny (create, update, delete) No one can create, update, or delete a plan through the rules.
     */
    match /plans/{planId} {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}