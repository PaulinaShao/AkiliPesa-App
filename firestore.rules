/**
 * @file Firestore Security Rules for AkiliPesa Revenue Reconciliation & Analytics Dashboard
 * @description This ruleset enforces a strict user-ownership model for user data and restricts access to revenue reports to a specific admin email.
 *
 * @dataStructure
 * - /users/{userId}: Stores user profile information; accessible only by the user.
 * - /users/{userId}/clones/{cloneId}: Stores user-specific digital clones; accessible only by the user.
 * - /users/{userId}/agents/{agentId}: Stores user-specific AI agents; accessible only by the user.
 * - /posts/{postId}: Stores all posts; publicly readable, but writes are restricted to the author.
 * - /products/{productId}: Stores product information; publicly readable, but writes are restricted to the owner.
 * - /orders/{orderId}: Stores order information; publicly readable.
 * - /payments/{paymentId}: Stores payment information; publicly readable.
 * - /plans/{planId}: Stores subscription plans; publicly readable.
 * - /calls/{callId}: Stores call session information; publicly readable.
 * - /transactions/{txId}: Stores transaction history; publicly readable.
 * - /adminSettings/{settingId}: Stores global admin settings.
 * - /adminAgents/{agentId}: Stores admin-created AI agents.
 * - /sales/{saleId}: Stores sales data; only accessible to admin.
 * - /walletTransactions/{txId}: Stores wallet transaction data; only accessible to admin.
 * - /withdrawalRequests/{requestId}: Stores withdrawal requests; only accessible to admin.
 * - /revenueReports/{reportId}: Stores daily revenue summaries; only accessible to a specific admin email.
 *
 * @keySecurityDecisions
 * - User data is strictly controlled by the user's ID.
 * - Revenue reports are only accessible to blagridigital@gmail.com.
 * - Public read access is granted to certain collections (e.g., /products, /posts) where data is intended to be publicly visible,
 *   but write access is always restricted to the owner or admin.
 * - Listing of user subcollections is allowed only to the owner.
 *
 * @denormalizationForAuthorization
 * - For the "Public Read with Owner-Only Writes" pattern on /posts and /products, the documents MUST contain an 'authorId' or 'ownerId' field, respectively,
 *   to enable secure validation of ownership on write operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants owner-only access to user profile data.
     * @path /users/{userId}
     * @allow (read, write, create) if the authenticated user's ID matches the userId.
     * @deny (read, write, create) if the authenticated user's ID does not match the userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants owner-only access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (read, write, create) if the authenticated user's ID matches the userId.
     * @deny (read, write, create) if the authenticated user's ID does not match the userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/clones/{cloneId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants owner-only access to user-specific agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (read, write, create) if the authenticated user's ID matches the userId.
     * @deny (read, write, create) if the authenticated user's ID does not match the userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/agents/{agentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to posts, but restricts writes to the author.
     * @path /posts/{postId}
     * @allow (read) to anyone.
     * @allow (create, update, delete) only to the author of the post.
     * @deny (create, update, delete) if the user is not the author.
     * @principle Public read access with owner-only writes.
     */
    match /posts/{postId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows public read access to products, but restricts writes to the owner.
     * @path /products/{productId}
     * @allow (read) to anyone.
     * @allow (create, update, delete) only to the owner of the product.
     * @deny (create, update, delete) if the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /products/{productId} {
      function isSignedIn() {
          return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to orders.
     * @path /orders/{orderId}
     * @allow (read) to anyone.
     * @deny (create, update, delete) to everyone.
     * @principle Public read, no writes.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to payments.
     * @path /payments/{paymentId}
     * @allow (read) to anyone.
     * @deny (create, update, delete) to everyone.
     * @principle Public read, no writes.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to plans.
     * @path /plans/{planId}
     * @allow (read) to anyone.
     * @deny (create, update, delete) to everyone.
     * @principle Public read, no writes.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to calls.
     * @path /calls/{callId}
     * @allow (read) to anyone.
     * @deny (create, update, delete) to everyone.
     * @principle Public read, no writes.
     */
    match /calls/{callId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to transactions.
     * @path /transactions/{txId}
     * @allow (read) to anyone.
     * @deny (create, update, delete) to everyone.
     * @principle Public read, no writes.
     */
    match /transactions/{txId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to admin settings, but only to admin
     * @path /adminSettings/{settingId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /adminSettings/{settingId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Allows read and write access to admin agents, but only to admin
     * @path /adminAgents/{agentId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /adminAgents/{agentId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }
    
    /**
     * @description Allows read and write access to revenue reports, but only to admin
     * @path /revenueReports/{reportId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /revenueReports/{reportId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }
    
        /**
     * @description Allows read and write access to sales data, but only to admin
     * @path /sales/{saleId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /sales/{saleId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }
    
            /**
     * @description Allows read and write access to wallet transaction data, but only to admin
     * @path /walletTransactions/{txId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /walletTransactions/{txId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }
    
                /**
     * @description Allows read and write access to withdrawal requests data, but only to admin
     * @path /withdrawalRequests/{requestId}
     * @allow (read, write) to admin only.
     * @deny (read, write) to everyone else.
     * @principle Admin only access.
     */
    match /withdrawalRequests/{requestId} {
      function isAdmin() {
        return isSignedIn() && request.auth.token.email == "blagridigital@gmail.com";
      }

      allow get, list, create, update, delete: if isAdmin();
    }
  }
}