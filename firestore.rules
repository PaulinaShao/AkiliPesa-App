/**
 * @fileoverview Firestore Security Rules for AkiliPesa application.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data protection, enforcing strict ownership for user-specific data and balancing public accessibility with controlled writes for shared content. It defaults to secure configurations where ambiguities exist.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`.
 * - User-generated content (clones, agents) is nested under their respective user IDs: `/users/{userId}/clones/{cloneId}` and `/users/{userId}/agents/{agentId}`.
 * - Public content (posts, products) is stored in top-level collections: `/posts/{postId}` and `/products/{productId}`.
 * - Transactional and operational data is stored in top-level collections: `/orders/{orderId}`, `/payments/{paymentId}`, `/calls/{callId}`, `/transactions/{txId}`, `/plans/{planId}`.
 * - Administrative data is stored in top-level collections: `/adminSettings/{settingId}` and `/adminAgents/{agentId}`.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed for privacy.
 * - Publicly readable collections require explicit ownership fields to control writes.
 *
 * Denormalization for Authorization:
 *  To create simpler, more performant rules, denormalize (copy) data required for an authorization decision directly onto the documents being secured. This avoids slow, costly, or impossible security checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, list, update, delete) Authenticated user can access their own profile.
     * @deny (create) An unauthenticated user cannot create a profile.
     * @deny (update, delete) A non-owner user cannot update or delete another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to posts.
     * @path /posts/{postId}
     * @allow (get, list) Any user can read any post.
     * @allow (create) Authenticated user can create a post with their ID as the authorId.
     * @allow (update, delete) Only the author can update or delete their post.
     * @deny (create) An unauthenticated user cannot create a post.
     * @deny (update, delete) A non-owner user cannot update or delete another user's post.
     * @principle Public read with owner-only writes.
     */
    match /posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(authorId) {
        return request.auth.uid == authorId;
      }

      function isExistingOwner(authorId) {
          return isOwner(authorId) && resource.data != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Controls access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) Authenticated user can create a clone under their ID.
     * @allow (get, list, update, delete) Authenticated user can access and manage their own clones.
     * @deny (create) An unauthenticated user cannot create a clone.
     * @deny (update, delete) A non-owner user cannot update or delete another user's clone.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/clones/{cloneId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to user-specific agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) Authenticated user can create an agent under their ID.
     * @allow (get, list, update, delete) Authenticated user can access and manage their own agents.
     * @deny (create) An unauthenticated user cannot create an agent.
     * @deny (update, delete) A non-owner user cannot update or delete another user's agent.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/agents/{agentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to products.
     * @path /products/{productId}
     * @allow (get, list) Any user can read any product.
     * @allow (create) Authenticated user can create a product with their ID as the ownerId.
     * @allow (update, delete) Only the owner can update or delete their product.
     * @deny (create) An unauthenticated user cannot create a product.
     * @deny (update, delete) A non-owner user cannot update or delete another user's product.
     * @principle Public read with owner-only writes.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
          return isOwner(ownerId) && resource.data != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to orders.
     * @path /orders/{orderId}
     * @allow (get) Any user can read any order.
     * @deny (list) Listing orders is not allowed.
     * @allow (create) Authenticated user can create an order.
     * @allow (update) Any authenticated user can update an order.
     * @allow (delete) Any authenticated user can delete an order.
     */
    match /orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to payments.
     * @path /payments/{paymentId}
     * @allow (get) Any user can read any payment.
     * @deny (list) Listing payments is not allowed.
     * @allow (create) Authenticated user can create a payment.
     * @allow (update) Any authenticated user can update a payment.
     * @allow (delete) Any authenticated user can delete a payment.
     */
    match /payments/{paymentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to plans.
     * @path /plans/{planId}
     * @allow (get, list) Any user can read any plan.
     * @allow (create) Authenticated user can create a plan.
     * @allow (update) Any authenticated user can update a plan.
     * @allow (delete) Any authenticated user can delete a plan.
     */
    match /plans/{planId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to calls.
     * @path /calls/{callId}
     * @allow (get) Any user can read any call.
     * @deny (list) Listing calls is not allowed.
     * @allow (create) Authenticated user can create a call.
     * @allow (update) Any authenticated user can update a call.
     * @allow (delete) Any authenticated user can delete a call.
     */
    match /calls/{callId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to transactions.
     * @path /transactions/{txId}
     * @allow (get) Any user can read any transaction.
     * @allow (list) Authenticated user can list transactions.
     * @allow (create) Authenticated user can create a transaction.
     * @allow (update) Any authenticated user can update a transaction.
     * @allow (delete) Any authenticated user can delete a transaction.
     */
    match /transactions/{txId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to admin settings.
     * @path /adminSettings/{settingId}
     * @allow (get, list) Any user can read any admin setting.
     * @allow (create) Authenticated user can create an admin setting.
     * @allow (update) Any authenticated user can update an admin setting.
     * @allow (delete) Any authenticated user can delete an admin setting.
     */
    match /adminSettings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to admin agents.
     * @path /adminAgents/{agentId}
     * @allow (get, list) Any user can read any admin agent.
     * @allow (create) Authenticated user can create an admin agent.
     * @allow (update) Any authenticated user can update an admin agent.
     * @allow (delete) Any authenticated user can delete an admin agent.
     */
    match /adminAgents/{agentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}