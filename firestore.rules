rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”§  GLOBAL HELPER FUNCTIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Custom claims (set by admin or backend)
    function isAdmin() {
      return isSignedIn() && (request.auth.token.role == 'admin' || request.auth.token.admin == true);
    }

    function isAgent() {
      return isSignedIn() && request.auth.token.role == 'agent';
    }

    function isCustomer() {
      return isSignedIn() && (
        !('role' in request.auth.token) ||
        request.auth.token.role == 'customer'
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ‘¤ USERS + SUBCOLLECTIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /users/{userId} {
      // Users can read/write their own record.
      allow read, update, delete: if isOwner(userId);
      // Admins can manage anyone.
      allow create, read, write: if isAdmin();
      // No list of all users for security.
      allow list: if false;
    }

    match /users/{userId}/clones/{cloneId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    match /users/{userId}/agents/{agentId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸŒ PUBLIC & SEMI-PUBLIC DATA
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /posts/{postId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /products/{productId} {
      allow read: if true;
      // Agents or admins may create/edit listings
      allow write: if isAgent() || isAdmin();
    }

    match /plans/{planId} {
      allow read: if true;
      allow write: if isAdmin(); // only admins manage plans
    }

    match /adminAgents/{agentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ’¼  USER-SPECIFIC FINANCIAL DATA
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /wallets/{walletId} {
      allow read: if isOwner(walletId) || isAdmin();
      allow write: if isAdmin(); // wallet balance handled by backend
    }

    match /transactions/{txId} {
      allow read: if isAdmin() ||
                  (isSignedIn() && request.auth.uid == resource.data.uid);
      allow write: if isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ’¬  ORDERS & ESCROW
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /orders/{orderId} {
      function orderData() {
        return get(/databases/$(database)/documents/orders/$(orderId)).data;
      }
      allow read: if isAdmin()
               || (isSignedIn() && (
                    request.auth.uid == orderData().buyerId ||
                    request.auth.uid == orderData().sellerId
                  ));
      allow write: if isAdmin(); // backend controls order flow
    }

    match /escrow/{escrowId} {
      allow read: if isAdmin() || isSignedIn();
      allow write: if isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ¤  TRUST & REPUTATION SYSTEM
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /trustScores/{userId} {
      // Anyone signed in can view trust score (for marketplace transparency)
      allow read: if isSignedIn();
      // Only backend or admin may write
      allow write: if isAdmin();
    }

    match /buyerTrust/{buyerId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â­  POINTS & REWARDS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /akiliPoints/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin();
    }

    match /rewardHistory/{rewardId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow write: if isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”” NOTIFICATIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /notifications/{notifId} {
      allow read, write: if isOwner(resource.data.uid) || isAdmin();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ‘¥ FOLLOWERS / SOCIAL GRAPH
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /followers/{followId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ§± DEFAULT DENY
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}