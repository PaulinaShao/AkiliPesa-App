/**
 * @fileoverview Firestore Security Rules for AkiliPesa application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user-specific data,
 * with some public read access for certain collections.  It also provides
 * elevated read access for an admin user (blagridigital@gmail.com).
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}.
 * - User-specific clones and agents are stored under /users/{userId}/clones/{cloneId} and /users/{userId}/agents/{agentId}.
 * - Posts, products, orders, payments, plans, calls and transactions are stored in top-level collections.
 * - Admin settings and agents are stored in top-level collections.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to protect user privacy.
 * - Public read access is granted to the /posts, /products, /plans, and /adminAgents collections. Writes to these collections are restricted to specific roles or conditions.
 * - The admin user (blagridigital@gmail.com) has elevated read access to the /transactions collection.
 * - All write operations are carefully controlled to prevent unauthorized data modification.
 *
 * Denormalization for Authorization:
 * - The /transactions/{txId} document includes a `uid` field to simplify owner-based authorization.  This avoids the need for complex queries or document lookups.
 *
 * Structural Segregation:
 * - Public data (e.g., posts, products) is stored in top-level collections, separate from private user data, to simplify read access rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants owner-only access to user profiles.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123.
     * @allow (get) - User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) - User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) - User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // Allow the user to read their own profile.
      allow get: if isOwner(userId);
      // Allow the user to create their own profile, but enforce that the userId matches the authenticated user's UID.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      // Allow the user to update their own profile.  Enforce that the userId cannot be changed.
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      // Allow the user to delete their own profile.
      allow delete: if isExistingOwner(userId);
      // Listing all users is not allowed.
      allow list: if false;
    }

    /**
     * @description Allows public read access to posts, but restricts writes to authenticated users.
     * @path /posts/{postId}
     * @allow (get, list) - Any user can read any post.
     * @allow (create) - User with UID 'user123' can create a post where authorId == 'user123'.
     * @allow (update) - User with UID 'user123' can update a post they own (resource.data.authorId == 'user123').
     * @allow (delete) - User with UID 'user123' can delete a post they own (resource.data.authorId == 'user123').
     * @deny (create) - User with UID 'user123' cannot create a post with authorId == 'user456'.
     * @principle Public read, owner-only writes.
     */
    match /posts/{postId} {
      // Allow anyone to read all posts.
      allow get, list: if true;
      // Only allow creation if the authorId matches the authenticated user's ID.
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      // Only allow updates if the user is the author of the post and the document exists.
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorId);
      // Only allow deletion if the user is the author of the post and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Grants owner-only access to user-specific clones.
     * @path /users/{userId}/clones/{cloneId}
     * @allow (create) - User with UID 'user123' can create a clone under /users/user123/clones/clone1.
     * @allow (get) - User with UID 'user123' can read their clone at /users/user123/clones/clone1.
     * @allow (update) - User with UID 'user123' can update their clone at /users/user123/clones/clone1.
     * @allow (delete) - User with UID 'user123' can delete their clone at /users/user123/clones/clone1.
     * @deny (create) - User with UID 'user456' cannot create a clone under /users/user123/clones/clone1.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/clones/{cloneId} {
      // Allow the owner to read their own clone.
      allow get, list: if isOwner(userId);
      // Allow the owner to create a new clone, enforcing that the userId matches the path.
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      // Allow the owner to update their own clone. Enforce that the userId is immutable.
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      // Allow the owner to delete their own clone.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants owner-only access to user-specific agents.
     * @path /users/{userId}/agents/{agentId}
     * @allow (create) - User with UID 'user123' can create an agent under /users/user123/agents/agent1.
     * @allow (get) - User with UID 'user123' can read their agent at /users/user123/agents/agent1.
     * @allow (update) - User with UID 'user123' can update their agent at /users/user123/agents/agent1.
     * @allow (delete) - User with UID 'user123' can delete their agent at /users/user123/agents/agent1.
     * @deny (create) - User with UID 'user456' cannot create an agent under /users/user123/agents/agent1.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/agents/{agentId} {
      // Allow the owner to read their own agent.
      allow get, list: if isOwner(userId);
      // Allow the owner to create a new agent, enforcing that the userId matches the path.
      allow create: if isOwner(userId); //&& request.resource.data.userId == userId;
      // Allow the owner to update their own agent. Enforce that the userId is immutable.
      allow update: if isExistingOwner(userId); //&& request.resource.data.userId == resource.data.userId;
      // Allow the owner to delete their own agent.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to products, but restricts writes to product owners.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read any product.
     * @allow (create) - User with UID 'user123' can create a product where ownerId == 'user123'.
     * @allow (update) - User with UID 'user123' can update a product they own (resource.data.ownerId == 'user123').
     * @allow (delete) - User with UID 'user123' can delete a product they own (resource.data.ownerId == 'user123').
     * @deny (create) - User with UID 'user123' cannot create a product with ownerId == 'user456'.
     * @principle Public read, owner-only writes.
     */
    match /products/{productId} {
      // Allow anyone to read all products.
      allow get, list: if true;
      // Only allow creation if the ownerId matches the authenticated user's ID.
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // Only allow updates if the user is the owner of the product and the document exists.
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      // Only allow deletion if the user is the owner of the product and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Restricts access to orders.
     * @path /orders/{orderId}
     * @allow (get) - Anyone can get an order.
     * @allow (list) - Anyone can list orders.
     * @allow (create) - No one can create an order.
     * @allow (update) - No one can update an order.
     * @allow (delete) - No one can delete an order.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to payments.
     * @path /payments/{paymentId}
     * @allow (get) - Anyone can get a payment.
     * @allow (list) - Anyone can list payments.
     * @allow (create) - No one can create a payment.
     * @allow (update) - No one can update a payment.
     * @allow (delete) - No one can delete a payment.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to plans, but restricts writes.
     * @path /plans/{planId}
     *  @allow (get, list) - Any user can read any plan.
     * @allow (create) - No one can create a plan.
     * @allow (update) - No one can update a plan.
     * @allow (delete) - No one can delete a plan.
     * @principle Public read, restricted writes.
     */
    match /plans/{planId} {
      // Allow anyone to read all plans.
      allow get, list: if true;
      // Only allow creation if the user is the author of the plan and the document exists.
      allow create: if false;
        // Only allow updates if the user is the author of the plan and the document exists.
      allow update: if false;
        // Only allow deletion if the user is the author of the plan and the document exists.
      allow delete: if false;
    }

    /**
     * @description Restricts access to calls.
     * @path /calls/{callId}
     * @allow (get) - Anyone can get a call.
     * @allow (list) - Anyone can list calls.
     * @allow (create) - No one can create a call.
     * @allow (update) - No one can update a call.
     * @allow (delete) - No one can delete a call.
     */
    match /calls/{callId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to transaction records.
     * @path /transactions/{txId}
     * @allow (get, list) - Admin (blagridigital@gmail.com) can read all, otherwise only owner can read.
     * @allow (create) - User can create only their own transaction.
     * @allow (update) - No client updates allowed.
     * @allow (delete) - No client deletes allowed.
     * @principle Restricted access based on ownership and admin role.
     */
    match /transactions/{txId} {
      allow get, list: if request.auth != null && (
        request.auth.token.email == "blagridigital@gmail.com" ||
        resource.data.uid == request.auth.uid
      );
      allow create: if request.auth != null &&
        request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Restricts access to admin settings.
     * @path /adminSettings/{settingId}
     * @allow (get) - Anyone can get admin settings.
     * @allow (list) - Anyone can list admin settings.
     * @allow (create) - No one can create admin settings.
     * @allow (update) - No one can update admin settings.
     * @allow (delete) - No one can delete admin settings.
     */
    match /adminSettings/{settingId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to admin agents, but restricts writes.
     * @path /adminAgents/{agentId}
     * @allow (get, list) - Any user can read any admin agent.
     * @allow (create) - No one can create an admin agent.
     * @allow (update) - No one can update an admin agent.
     * @allow (delete) - No one can delete an admin agent.
     * @principle Public read, restricted writes.
     */
    match /adminAgents/{agentId} {
      // Allow anyone to read all admin agents.
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Helper function to determine if the current user is the owner of the document.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is signed in and the provided userId matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Helper function to determine if the current user is the owner of an existing document.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is signed in, the provided userId matches the authenticated user's ID, and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Helper function to determine if the user is signed in.
     * @return {boolean} True if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}